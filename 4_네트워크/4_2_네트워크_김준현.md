# 3. 네트워크 계층 - IP

IP (Internet Protocol) : 네트워크 계층의 가장 핵심적인 프로토콜 

## IP의 목적과 특징

1. 주소 지정 (addressing) : 네트워크 간의 통신 과정에서 호스트를 특정하는 것

2. 단편화 (fragmentation) : 데이터를 여러 IP 패킷으로 올바르게 쪼개어 보내는 것

- 특징 : 신뢰할 수 없는 통신, 비연결형 통신

### 주소 지정과 단편화

주소 지정은 **IP 주소**를 통해 이루어지며,이는 IP 패킷 헤더를 통해 알 수 있다.

<img width="588" height="374" alt="image" src="https://github.com/user-attachments/assets/6693dda5-6471-43a4-a259-16e68a0a7bc6" />

- 패킷을 올바르게 전송하기 위해서는 MAC 주소와 IP 주소가 모두 필요하다.

- 패킷의 송수신 과정에서 MAC 주소보다는 IP주소가 우선적으로 활용된다.

- 라우터 : 서로 다른 네트워크에 속한 두 호스트가 네트워크 간 통신을 수행할 때, IP 주소를 기반으로 패킷의 최적 경로를 결정하여 목적지까지 전달(라우팅)하는 네트워크 장비

단편화는 여러 IP 패킷으로 올바르게 쪼개어 보내는 것을 의미한다.

- 패킷이 수용할 수 있는 최대 전송 단위를 Maximum Transmission Unit(MTU)라고 하는데, IP 패킷의 크기가 MTU를 넘어갈 경우, 이를 분할한 뒤 여러 개로 전송한다.(MTU의 최대 크기는 1500바이트다)

- 분할된 패킷은 도착지에서 합쳐진다. 이 때, 식별자와 단편화 오프셋 플래그가 사용된다.

- 잦은 단편화는 많은 네트워크 비용을 야기하며, 이를 회피하기 위해 “경로 MTU 발견” 기술을 이용한다.

- 해당 기술은 패킷을 주고받을 경로에 존재하는 모든 호스트의 처리 가능 MTU 크기를 탐지하고 최대 MTU 값으로 패킷을 송수신하는 원리를 가진다.

### 신뢰할 수 없는 통신과 비연결형 통신

신뢰할 수 없는 프로토콜

- 패킷이 수신지까지 제대로 전송되었다고 보장하지 않는 프로토콜을 의미한다. 최선형 전달이라고도 부른다.

- IP 프로토콜이 포함되며, 주로 TCP와 UDP의 존재 목적과도 연결된다.

비연결형 프로토콜

- 받는 대상의 수신 가능 여부를 고려하지 않는 프로토콜을 의미한다.

- IP 프로토콜이 포함되며, 이와 반대로 TCP는 연결형 프로토콜이다.

## IP 주소의 구조

### 클래스풀 주소 체계

### 클래스리스 주소 체계와 서브넷 마스크

## 공인 IP 주소와 사설 IP 주소

- 호스트의 IP 주소는 명령어 ipconfig/all (윈도우) 또는 ifconfig (맥OS, 리눅스) 입력하여 확인 가능

- 공인 IP 주소 : 고유한 IP 주소, 검색 사이트를 통해 확인 했던 IP 주소

- 사설 IP 주소 : 고유하지 않은 IP 주소, 사설 네트워크에서 사용하기 위한 IP 주소

  - 공유기(라우터)를 통해 일반적으로 할당됨
 
  - 해당 호스트가 속한 사설 네트워크 상에서만 유효한 주소이므로, 다른 네트워크 상의 사설 IP 주소와 중복될 수 있다.
 
  - 예약 IP 주소 범위
 
    - 10.0.0.0/8 (10.0.0.0 ~ 10.255.255.255)
   
    - 172.16.0.0/12 (172.16.0.0 ~ 172.31.255.255)
   
    - 192.168.0.0/16 (192.168.0.0 ~ 192.168.255.255) 

## IP 주소의 할당

호스트에 IP 주소를 할당하는 방법

1. 정적 할당 : 수작업을 통해 이루어진다.

2. 동적할당 : DHCP라는 프로토콜을 통해 이루어진다.

### 정적 할당

- 직접 수작업으로 IP 주소를 부여하는 방식

- 각 운영체제별(맥OS, 윈도우) IP 주소를 수동으로 설정하는 설정 또는 명령어가 있다.

- 정적 IP 주소를 부여하기 위해 필요한 값 :

  - 정적 IP 주소를 부여하고자 하는 IP 주소, 서브넷 마스크, 게이트웨이(라우터) 주소, DNS 주소 등

- 게이트웨이 : 서로 다른 네트워크를 연결하는 하드웨어적/소프트웨어적 수단

  - 기본 게이트웨이 : 호스트가 속한 네트워크의 외부로 나가기 위한 첫 기본 경로 

- DNS 주소 : 호스트가 도메인 네임을 토대로 IP 주소를 알아내기 위해 질의하는 서버의 주소

  - 도메인 네임 : IP 주소에 대응되는 기억할 수 있는 문자열로 호스트를 식별할 수 있는 수단

  - 호스트가 도메인 네임을 토대로, 이에 대응되는 IP 주소를 알아내려면 <도메인 네임, IP 주소> 쌍을 저장하는 서버(네임 서버, DNS 서버)에 질의해야 한다.
    
### 동적 할당: DHCP (Dynamic Host Configuration Protocol)

- 프로토콜을 통해 자동으로 IP 주소를 부여하는 방식


- DHCP 서버 : 호스트에 할당 가능한 IP 주소 목록을 관리하다가, IP 주소 할당 요청을 받았을 때 IP 주소를 할당해 주는 호스트

  - 라우터(공유기)가 DHCP 서버 역할을 수행

  - IP 주소를 동적으로 할당받고자 하는 호스트는 DHCP 서버와 메시지를 주고 받으며 동적 IP 주소를 할당받을 수 있다.

- 동적 IP 주소 : 동적 할당을 통해 할당된 IP 주소
    
  1. 동적 IP 주소에는 사용 가능한 기간(임대 기간)이 정해져 있다.

  2. 동적 IP 주소는 할당받을 때마다 다른 주소를 받을 수 있다.
 
## IP 전송 특징의 보완: ICMP

신뢰할 수 없는 전송과 연결을 수립하지 않는 전송이 반드시 나쁜 것일까? 그렇지 않다.

IP가 신뢰할 수 없는 비연결형 프로토콜인 주된 이유는 **성능**에 있다.

## IP 주소와 MAC 주소의 대응: ARP


# 4. 전송 계층 - TCP와 UDP

## TCP와 UDP의 목적과 특징

### 포트를 통한 프로세스 식별

- IP주소(호스트 식별)와 포트번호(애플리케이션 프로세스 식별)의 조합을 통해 '특정 호스트가 실행하는 특정 프로세스'를 식별할 수 있다.

- 전송 계층(TCP, UDP)의 주된 목적 : 포트를 통한 프로세스 식별

- 포트 번호는 16비트로 표현되며 3가지 종류가 있다.

  - 잘 알려진 포트 : 범용적으로 사용되는 프로토콜이 주로 사용하는 포트 번호 목록(0 ~ 1023번)

    - FTP(20, 21), SSH(22), DNS(53), DHCP(67, 68), HTTP(80), 443(HTTPS) 
 
  - 등록된 포트 : 흔하게 사용되는 프로토콜에 할당된 포트 번호 목록 (1024 ~ 49151번)

    - OpenVPN(1194), 1433(SQL Server 데이터베이스), 3306(MySQL 데이터베이스), 6379(Redis), 8080(HTTP 대체) 
 
  - 동적 포트 : 49152 ~ 65535번
 
### NAT와 포트

- NAT (Network Address Translation) : 공인 IP 주소와 사설 IP 주소 간 변환을 위해 사용하는 기술

- 하나의 공인 IP 주소에는 여러 개의 사설 IP 주소가 할당될 수 있다.

- 이 과정에서 공인 IP를 사설 IP로 변경하는 경우, 사설 IP를 구분해야 하는데, 이 때 포트 번호가 사용된다. 이러한 기술을 NAPT라고 한다. (현대의 NAPT는 보통 NAT라고 부른다)

- 공인 IP와 사설 IP는 라우터 등 게이트웨이에서 테이블 형태로 관리한다.

### (비)신뢰성과 (비)연결형 보장

- TCP

  - 신뢰, 연결형 프로토콜이다.

  - 신뢰성 확보를 위해 상태 관리, 흐름제어, 오류 제어, 혼잡 제어 기능을 제공한다.

  - 연결성 확보를 위해 핸드 쉐이크 기반 연결 종료 과정을 가진다.

  - 신뢰, 연결성 구축 때문에 UDP보다 송수신 속도가 느리며, 많은 정보를 제공해야 하기 때문에 헤더의 크기가 비대하다.(대부분의 필드가 신뢰성과 연결성 확보에 사용된다)

- TCP 헤더

  <img width="1024" height="418" alt="image" src="https://github.com/user-attachments/assets/a03a7b75-49bf-4b8a-9851-ea7f1ade80e6" />


TCP 헤더의 구성은 다음과 같다.

  - 순서 번호

    - TCP 패킷의 순서를 보장하기 위해 세그먼트 첫 바이트에 매겨진 번호다.

    - 첫 패킷을 전송할 때는 임의의 수를 전송하며, 이후에는 임의의 수 + 전송할 페이로드의 바이트 위치를 보낸다.

    - 순서 번호를 통해 현재 주고받는 TCP 세그먼트가 송수신하고자 하는 데이터의 몇 번째 바이트에 해당하는지 알 수 있다.

  - 확인 응답 번호

    - 상대 호스트가 보낸 세그먼트에 대한 응답으로, 다음으로 수신하길 기대하는 순서 번호다. 즉, 해당 패킷을 잘 받았고, 다음 패킷을 내놓으라는 신호다.

    - 응답 송신 시, ACK 플래그를 1로 설정한 뒤, 응답 받은 순서 번호 + 1 크기의 숫자를 반환한다.

    - 이를 통해, 쪼개진 패킷의 순서 정리와 누락 여부를 검즘할 수 있다.

  - 순서 번호 + 확인 응답 번호 예시(A, B 호스트)

    - 1000 바이트의 페이로드를 10번 쪼개 보낼 때, A는 처음에 임의의 수 100000을 순서 번호에 담아 전송한다.(결론 100000 전송)

    - B는 이를 확인하고 다음에 받아야 할 데이터 위치를 송신자에게 전송한다. B는 송신 받은 TCP 헤더를 통해 페이로드의 크기를 확인할 수 있다.(즉, 데이터의 크기가 100 바이트임을 알 수 있다) 이 때, 확인 응답 번호에 100100, ACK flag는 1로 담아 A에게 전송한다.

    - A는 이를 받은 뒤, 확인 응답 번호인 100100 값과 해당 페이로드를 송신자에게 전송한다.

    - 같은 방식으로 반복된다.

  - 제어 비트

    - 현재 세그먼트에 대한 부가 정보, 8개의 비트로 구성된다.

    - ACK : 세그먼트 승인 여부 확인

    - SYN : 연결 수립 확인
   
    - FIN : 연결 종료 확인
   
- UDP

  <img width="1014" height="256" alt="image" src="https://github.com/user-attachments/assets/38f81025-c4ca-446c-9c0e-ab2343f3d1f7" />


  - 비신뢰, 비연결형 프로토콜이다.

  - 전송 속도가 빠르며, 헤더가 간단하다

- UDP 헤더

  - 송신지 포트, 수신지 포트 : 송수신지 포트 번호

  - 길이 : 헤더를 포함한 UDP 패킷의 바이트 크기

  - 채크섬 : 데이터그램 훼손 여부 확인

## TCP의 연결부터 종료까지

TCP의 연결

  - TCP는 신뢰성을 위해 호스트 간의 연결과 종료 과정을 거친다. 이 때 핸드쉐이크 개념이 사용된다.

액티브, 패시브

  - 액티브 : 처음 연결 및 종료를 시작하는 과정

  - 패시브 : 요청을 수신한 뒤, 그에 대한 연결 및 종료를 수립하는 과정

### TCP의 연결 수립

  - 호스트간 연결 수립을 위해 3 웨이 핸드쉐이크 기술이 사용된다.

  - 과정은 다음과 같다.

    - A → B : SYN 세그먼트 전송

      - 호스트 A는 B에게 SYN 세그먼트가 1인 패킷을 전송한다.

      - 이 때, 호스트들의 포트번호, 순서 번호, 제어 비트 등이 전송된다.

      - 여기서 순서 번호는 임의의 수다.

    - B → A : ACK + SYN 세그먼트 전송

      - 호스트 B는 A에서 ACK + SYN 세그먼트가 각각 1인 패킷을 전송한다.

      - 이 때, 호스트들의 포트 번호, 순서 번호, 확인 응답 번호, 제어 비트 등이 전송된다.

      - 여기서 확인 응답 번호는 이전 세그먼트의 순서 번호 + 1이다.

      - 또한, 새로운 임의의 순서 번호를 전송한다.

    - A → B : ACK 세그먼트 전송

      - 세그먼트를 받은 호스트 A는 ACK 비트가 1로 설정된 세그먼트를 호스트 B에 전송한다.

      - 이 때, 확인 응답 번호에는 B로부터 받은 순서 번호 + 1 값이 저장된다.

      - 또한, 순서 번호에는 기존 A의 순서 번호 + 1 값이 저장된다

### TCP의 오류/흐름/혼잡 제어

### TCP의 종료

## TCP의 상태 관리
